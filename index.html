<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Encountr • Maya Demo</title>
  <link rel="icon" href="data:," />
  <style>
    :root { --ink:#0f172a; --soft:#f8fafc; --accent:#2563eb; }
    body{margin:0;background:var(--soft);color:var(--ink);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto;}
    .wrap{max-width:880px;margin:0 auto;padding:24px;}
    header{display:flex;justify-content:space-between;align-items:center;margin:8px 0 16px;}
    .logo{font-weight:700;font-size:20px;letter-spacing:.3px}
    .tag{font-size:12px;color:#475569}
    .card{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(2,6,23,.06);padding:20px;margin:16px 0;}
    h1{font-size:28px;margin:0 0 8px}
    h2{font-size:18px;margin:0 0 8px}
    ol{padding-left:18px;margin:8px 0}
    .hint{font-size:14px;color:#475569}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media (min-width:860px){ .grid{grid-template-columns:1fr 1fr} }
    .btn{display:inline-block;background:var(--accent);color:#fff;text-decoration:none;padding:10px 14px;border-radius:10px;font-weight:600}
    .footer{font-size:12px;color:#64748b;margin:24px 0 8px}
    textarea,input,select{width:100%;border:1px solid #e2e8f0;border-radius:10px;padding:10px;font:inherit;background:#fff}
    label{font-size:14px;color:#334155;margin:8px 0 6px;display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">Encountr</div>
      <div class="tag">relationship analysis through voice</div>
    </header>

    <div class="card">
      <h1>Maya — Onboarding Demo</h1>
      <p class="hint">Tap the widget, allow mic access, and answer the 18 quick questions. Your profile will appear in your Encountr dashboard—results are not read aloud.</p>
      <!-- ElevenLabs Widget -->
      <elevenlabs-convai agent-id="agent_1701k70fs0asensb5xvb3rrqjr50"></elevenlabs-convai>
      <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>
      <p class="hint">Tip: works best in Chrome (desktop or mobile). Use headphones in a noisy room.</p>
    </div>

    <div class="grid">
      <div class="card">
        <h2>How to test (2 minutes)</h2>
        <ol>
          <li>Click the widget • allow microphone.</li>
          <li>Say “Ready” and answer the 18 questions in your normal speaking voice.</li>
          <li>At the end, Maya will say the profile will be sent to your dashboard.</li>
        </ol>
        <p class="hint">If something feels off (latency, mishears, pacing), note it below.</p>
      </div>

      <div class="card">
        <h2>Quick feedback</h2>
        <!-- Form submits to Formspree endpoint -->
        <form id="feedback-form" method="post" action="https://formspree.io/f/mvgdppdg" accept-charset="UTF-8">
          <label>Name (optional)</label>
          <input name="name" placeholder="Your name" />

          <label>Email (optional)</label>
          <input name="email" type="email" placeholder="you@company.com" />

          <label>Overall experience</label>
          <select name="rating" required>
            <option value="" disabled selected>Choose…</option>
            <option>Excellent</option><option>Good</option>
            <option>Okay</option><option>Poor</option>
          </select>

          <label>What worked well?</label>
          <textarea name="pros" rows="3" placeholder="Clarity, speed, tone…"></textarea>

          <label>What needs improvement?</label>
          <textarea name="cons" rows="3" placeholder="Mishears, long pauses, phrasing…"></textarea>

          <label>Device & browser</label>
          <input name="env" placeholder="e.g., iPhone 14 / Chrome 120" />

          <div style="margin-top:10px">
            <button class="btn" type="submit">Submit feedback</button>
          </div>
        </form>
        <p class="hint" id="feedback-success" style="display:none">Thanks for your feedback — we appreciate it!</p>
        <noscript><p class="hint">JavaScript is disabled. Please use this link to submit: <a href="https://formspree.io/f/mvgdppdg" target="_blank" rel="noopener">Open feedback form</a>.</p></noscript>
        <p class="hint">No Google Form yet? Swap the <code>action=</code> above with your Form link or a simple webhook collector.</p>
      </div>
    </div>

    <div class="card">
      <h2>Your attachment style</h2>
      <p class="hint">After completing your call with Maya, your attachment style for business relationships will appear here automatically.</p>
      <div id="attachment-waiting" style="display:none;margin-top:16px">
        <p style="color:#64748b;font-style:italic">⏳ Processing your call results...</p>
      </div>
      <div id="attachment-result" style="display:none;margin-top:16px">
        <p class="hint">Your attachment style:</p>
        <div id="attachment-profile" style="font-weight:700;font-size:24px;color:var(--accent)">—</div>
      </div>
    </div>

    <div class="card">
      <h2>Known test script</h2>
      <p class="hint">If you want consistency across testers, try to answer in full sentences and avoid yes/no only.</p>
      <a class="btn" href="#" onclick="alert('Tip: speak naturally; short pauses are fine.')" aria-label="Testing tips">Testing tips</a>
    </div>

    <div class="footer">© Encountr. Sounds right.</div>
  </div>
  <script>
    // Select the feedback form element
    const feedbackForm = document.getElementById('feedback-form');
    // Select the thank-you message element
    const feedbackSuccess = document.getElementById('feedback-success');
    // Select the attachment profile elements
    const attachmentWaiting = document.getElementById('attachment-waiting');
    const attachmentResult = document.getElementById('attachment-result');
    const attachmentValue = document.getElementById('attachment-profile');
    // Store the webhook endpoint URL provided by Encountr
    const WEBHOOK_URL = 'https://n8n.encountr.ai/webhook/41fac57f-ff3d-4dcf-a4ac-9c76d995502d';
    // Placeholder for the HMAC secret used to sign webhook requests (replace before deploying)
    const WEBHOOK_SECRET = 'wsec_5292680e0d7d903114d3908427c43980c2d42fbc46f90657f461f9229a09312c';
    
    // Generate or retrieve a unique session ID for this page load
    let sessionId = sessionStorage.getItem('encountr_session_id');
    if (!sessionId) {
      sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      sessionStorage.setItem('encountr_session_id', sessionId);
    }
    console.log('Session ID:', sessionId);
    
    // Store polling state
    let pollingInterval = null;
    let pollAttempts = 0;
    const MAX_POLL_ATTEMPTS = 60; // Poll for up to 5 minutes (60 * 5 seconds)

    // Only proceed if the form exists on the page
    if (feedbackForm) {
      // Listen for form submission
      feedbackForm.addEventListener('submit', function(event) {
        // Prevent default navigation
        event.preventDefault();
        // Locate the submit button inside the form
        const submitBtn = feedbackForm.querySelector('button[type="submit"]');
        // Disable the button while sending
        if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Sending...'; }
        // Prepare form data
        const formData = new FormData(feedbackForm);
        // Helper: handle successful submission
        function handleSuccess() {
          feedbackForm.reset();
          feedbackForm.style.display = 'none';
          if (feedbackSuccess) { feedbackSuccess.style.display = 'block'; }
        }
        // Helper: handle failures and re-enable button
        function handleFailure(message) {
          if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Submit feedback'; }
          alert(message || 'Sorry, something went wrong. Please try again later.');
        }
        // Prefer fetch if available
        if (window.fetch) {
          fetch(feedbackForm.action, {
            method: feedbackForm.method.toUpperCase(),
            body: formData,
            headers: { 'Accept': 'application/json' }
          }).then(function(response) {
            if (response.ok) { handleSuccess(); }
            else { handleFailure(); }
          }).catch(function() {
            handleFailure('Network error. Please try again later.');
          });
        } else {
          // Fallback: XMLHttpRequest for older browsers
          var xhr = new XMLHttpRequest();
          xhr.open(feedbackForm.method.toUpperCase(), feedbackForm.action);
          xhr.setRequestHeader('Accept', 'application/json');
          xhr.onreadystatechange = function () {
            if (xhr.readyState !== XMLHttpRequest.DONE) return;
            if (xhr.status >= 200 && xhr.status < 300) { handleSuccess(); }
            else { handleFailure(); }
          };
          xhr.send(formData);
        }
      });
    }

    // Helper to parse a string like "{'profile_type': 'Secure'}" safely
    function parseMaybeStringJson(value) {
      if (typeof value === 'string') {
        try { return JSON.parse(value.replace(/'/g, '"')); } catch (_) { return null; }
      }
      if (value && typeof value === 'object') return value;
      return null;
    }

    // Try to extract and render the profile type from a payload
    function maybeRenderProfile(payload) {
      const raw = payload && payload.data_collection_results && payload.data_collection_results.eq_analysis && payload.data_collection_results.eq_analysis.value;
      const parsed = parseMaybeStringJson(raw);
      const profileType = parsed && (parsed.profile_type || parsed.profileType);
      if (profileType && attachmentResult && attachmentValue) {
        attachmentValue.textContent = profileType;
        if (attachmentWaiting) { attachmentWaiting.style.display = 'none'; }
        attachmentResult.style.display = 'block';
        console.log('Profile rendered successfully:', profileType);
        return true;
      }
      return false;
    }

    // Helper to extract the conversation id from different payload shapes
    function extractConversationId(payload) {
      if (!payload) return null;
      if (payload.conversationId) return payload.conversationId;
      if (payload.dynamic_variables && payload.dynamic_variables.system__conversation_id) {
        return payload.dynamic_variables.system__conversation_id;
      }
      if (payload.system__conversation_id) return payload.system__conversation_id;
      return null;
    }

    // Compute the required HMAC signature for the webhook POST body
    async function computeWebhookSignature(message) {
      if (!WEBHOOK_SECRET || !window.crypto || !window.crypto.subtle) return null;
      const encoder = new TextEncoder();
      const keyData = encoder.encode(WEBHOOK_SECRET);
      const algorithm = { name: 'HMAC', hash: 'SHA-256' };
      const cryptoKey = await window.crypto.subtle.importKey('raw', keyData, algorithm, false, ['sign']);
      const signatureBuffer = await window.crypto.subtle.sign('HMAC', cryptoKey, encoder.encode(message));
      const signatureArray = Array.from(new Uint8Array(signatureBuffer));
      return signatureArray.map((byte) => byte.toString(16).padStart(2, '0')).join('');
    }

    // Fetch the attachment profile using the session ID
    async function fetchProfileBySession() {
      if (!sessionId || !WEBHOOK_URL) {
        console.log('Missing sessionId or WEBHOOK_URL');
        return false;
      }
      console.log('Fetching profile for session:', sessionId);
      const body = JSON.stringify({ session_id: sessionId, action: 'get_profile' });
      const headers = { 'Content-Type': 'application/json' };
      const signature = await computeWebhookSignature(body);
      if (signature) { 
        headers['x-signature'] = signature;
      }
      try {
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          mode: 'cors',
          headers,
          body
        });
        console.log('Response status:', response.status);
        if (!response.ok) {
          console.error('Response not OK:', response.status, response.statusText);
          return false;
        }
        const data = await response.json().catch(() => null);
        console.log('Received data:', data);
        if (!data) return false;
        return maybeRenderProfile(data);
      } catch (error) {
        console.error('Webhook fetch failed:', error);
        return false;
      }
    }
    
    // Start polling for profile results
    function startPolling() {
      if (pollingInterval) return; // Already polling
      console.log('Starting to poll for results...');
      if (attachmentWaiting) { attachmentWaiting.style.display = 'block'; }
      pollAttempts = 0;
      
      pollingInterval = setInterval(async () => {
        pollAttempts++;
        console.log(`Poll attempt ${pollAttempts}/${MAX_POLL_ATTEMPTS}`);
        
        const success = await fetchProfileBySession();
        if (success) {
          console.log('Profile loaded successfully!');
          stopPolling();
          if (attachmentWaiting) { attachmentWaiting.style.display = 'none'; }
        } else if (pollAttempts >= MAX_POLL_ATTEMPTS) {
          console.warn('Max poll attempts reached, stopping');
          stopPolling();
          if (attachmentWaiting) { 
            attachmentWaiting.innerHTML = '<p style="color:#ef4444">Unable to load profile. Please refresh and try again.</p>';
          }
        }
      }, 5000); // Poll every 5 seconds
    }
    
    // Stop polling
    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
    }

    // Listen for postMessage events from the ElevenLabs widget
    window.addEventListener('message', async function(event) {
      if (!event || !event.data) return;
      console.log('postMessage received:', event.data);
      if (maybeRenderProfile(event.data)) return;
      if (event.data.detail && maybeRenderProfile(event.data.detail)) return;
      const conversationId = extractConversationId(event.data) || extractConversationId(event.data.detail);
      if (conversationId) { 
        lastConversationId = conversationId;
        console.log('Conversation ID captured from postMessage:', conversationId);
      }
    });

    // Store the last conversation ID from widget events
    let lastConversationId = null;

    // Also listen for possible custom events emitted by the widget
    const convaiEl = document.querySelector('elevenlabs-convai');
    if (convaiEl) {
      console.log('ElevenLabs widget found, attaching event listeners');
      convaiEl.addEventListener('conversationEnded', async function(ev) {
        console.log('conversationEnded event fired:', ev);
        const conversationId = extractConversationId(ev && ev.detail);
        if (conversationId) { 
          lastConversationId = conversationId;
          console.log('Stored conversation ID:', conversationId);
        }
        if (ev && ev.detail) { 
          console.log('Event detail:', ev.detail);
          if (maybeRenderProfile(ev.detail)) {
            console.log('Profile rendered from event');
            return;
          }
        }
        // Start polling for results
        console.log('Conversation ended, starting to poll for profile...');
        startPolling();
      });
      convaiEl.addEventListener('conversation-update', async function(ev) {
        console.log('conversation-update event fired');
        const conversationId = extractConversationId(ev && ev.detail);
        if (conversationId) { 
          lastConversationId = conversationId;
          console.log('Updated conversation ID:', conversationId);
        }
        if (ev && ev.detail && maybeRenderProfile(ev.detail)) return;
      });
    } else {
      console.warn('ElevenLabs widget element not found');
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
      stopPolling();
    });
  </script>
</body>
</html>
